<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
            background-color: #f1f8ff;
        }
        .status-badge {
            font-size: 1rem;
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: #212529;
            color: #f8f9fa;
            padding: 10px;
            font-family: monospace;
            border-radius: 5px;
        }
        .log-entry {
            margin: 0;
            padding: 2px 0;
            border-bottom: 1px solid #343a40;
        }
        .chart-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .chart-img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .pair-card {
            margin-bottom: 15px;
        }
        .pair-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pair-title {
            margin: 0;
            font-size: 1.2rem;
        }
        .pair-badge {
            font-size: 0.9rem;
        }
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ICT Trading Bot Dashboard</span>
                        <span id="bot-status" class="badge bg-secondary status-badge">Initializing...</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Bot Information</h5>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Trading Pairs:</td>
                                            <td id="trading-pairs">-</td>
                                        </tr>
                                        <tr>
                                            <td>Total Portfolio Value:</td>
                                            <td id="total-value">-</td>
                                        </tr>
                                        <tr>
                                            <td>Active Positions:</td>
                                            <td id="active-positions">-</td>
                                        </tr>
                                        <tr>
                                            <td>Last Update:</td>
                                            <td id="last-update">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5>Performance Metrics</h5>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td>Total Trades:</td>
                                            <td id="total-trades">-</td>
                                        </tr>
                                        <tr>
                                            <td>Win Rate:</td>
                                            <td id="win-rate">-</td>
                                        </tr>
                                        <tr>
                                            <td>Control:</td>
                                            <td>
                                                <button id="toggle-bot" class="btn btn-sm btn-primary">Start/Stop Bot</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        Trading Pairs
                    </div>
                    <div class="card-body">
                        <div id="pairs-container" class="row">
                            <!-- Pair cards will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Live Logs</span>
                        <select id="log-selector" class="form-select form-select-sm" style="width: auto;">
                            <option value="multi_token_trader.log">Multi Token Trader</option>
                            <option value="dashboard.log">Dashboard</option>
                            <option value="trade.log">Trade</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div id="log-container" class="log-container">
                            <p class="log-entry">Loading logs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="refresh-data" class="btn btn-primary refresh-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
        </svg>
        Refresh
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to update the dashboard with bot status
        function updateDashboard() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update bot status badge
                    const statusBadge = document.getElementById('bot-status');
                    if (data.is_running) {
                        statusBadge.textContent = 'Running';
                        statusBadge.className = 'badge bg-success status-badge';
                    } else {
                        statusBadge.textContent = 'Stopped';
                        statusBadge.className = 'badge bg-danger status-badge';
                    }
                    
                    // Update bot information
                    document.getElementById('trading-pairs').textContent = data.pairs.join(', ');
                    document.getElementById('total-value').textContent = data.total_value.toFixed(2) + ' BUSD';
                    document.getElementById('active-positions').textContent = data.active_positions;
                    document.getElementById('last-update').textContent = data.last_update;
                    
                    // Update performance metrics
                    document.getElementById('total-trades').textContent = data.total_trades;
                    document.getElementById('win-rate').textContent = data.win_rate + '%';
                    
                    // Update pair cards
                    updatePairCards(data.pairs);
                })
                .catch(error => console.error('Error fetching bot status:', error));
        }
        
        // Function to update pair cards
        function updatePairCards(pairs) {
            const pairsContainer = document.getElementById('pairs-container');
            
            // Clear existing cards
            pairsContainer.innerHTML = '';
            
            // Fetch status for each pair
            fetch('/api/pair_status')
                .then(response => response.json())
                .then(pairData => {
                    // Create a card for each pair
                    pairs.forEach(pair => {
                        const pairInfo = pairData[pair] || {};
                        
                        const card = document.createElement('div');
                        card.className = 'col-md-4';
                        card.innerHTML = `
                            <div class="card pair-card">
                                <div class="card-header pair-header">
                                    <h5 class="pair-title">${pair}</h5>
                                    <span class="badge ${pairInfo.position_open ? 'bg-warning' : 'bg-info'} pair-badge">
                                        ${pairInfo.position_open ? 'Position Open' : 'No Position'}
                                    </span>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <td>Current Price:</td>
                                                <td>${pairInfo.current_price ? pairInfo.current_price.toFixed(2) : '-'}</td>
                                            </tr>
                                            <tr>
                                                <td>Market Bias:</td>
                                                <td>${pairInfo.market_bias || 'Unknown'}</td>
                                            </tr>
                                            <tr>
                                                <td>Active FVGs:</td>
                                                <td>${pairInfo.active_fvgs || 0}</td>
                                            </tr>
                                            <tr>
                                                <td>Total Trades:</td>
                                                <td>${pairInfo.total_trades || 0}</td>
                                            </tr>
                                            <tr>
                                                <td>Win Rate:</td>
                                                <td>${pairInfo.win_rate ? pairInfo.win_rate + '%' : '0%'}</td>
                                            </tr>
                                            <tr>
                                                <td>Avg. Profit:</td>
                                                <td>${pairInfo.avg_profit ? pairInfo.avg_profit + '%' : '0%'}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        pairsContainer.appendChild(card);
                    });
                })
                .catch(error => console.error('Error fetching pair status:', error));
        }
        
        // Function to update logs
        function updateLogs() {
            const logFile = document.getElementById('log-selector').value;
            fetch(`/api/logs?file=${logFile}`)
                .then(response => response.json())
                .then(data => {
                    const logContainer = document.getElementById('log-container');
                    logContainer.innerHTML = '';
                    
                    data.logs.forEach(log => {
                        const logEntry = document.createElement('p');
                        logEntry.className = 'log-entry';
                        logEntry.textContent = log;
                        logContainer.appendChild(logEntry);
                    });
                    
                    // Scroll to bottom
                    logContainer.scrollTop = logContainer.scrollHeight;
                })
                .catch(error => console.error('Error fetching logs:', error));
        }
        
        // Toggle bot status
        document.getElementById('toggle-bot').addEventListener('click', function() {
            fetch('/api/toggle')
                .then(response => response.json())
                .then(data => {
                    console.log('Bot status toggled:', data);
                    updateDashboard();
                })
                .catch(error => console.error('Error toggling bot status:', error));
        });
        
        // Refresh button
        document.getElementById('refresh-data').addEventListener('click', function() {
            updateDashboard();
            updateLogs();
        });
        
        // Log selector change
        document.getElementById('log-selector').addEventListener('change', updateLogs);
        
        // Initial update
        updateDashboard();
        updateLogs();
        
        // Set up periodic updates
        setInterval(updateDashboard, 5000);
        setInterval(updateLogs, 10000);
    </script>
</body>
</html>